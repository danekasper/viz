
<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Panic. I have no TP.</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <link rel="stylesheet" href="https://leeoniya.github.io/uPlot/src/uPlot.css">
    <script src="https://leeoniya.github.io/uPlot/dist/uPlot.iife.js"></script>
    <script src="/js/covid.js"></script>
  </head>
  <body>
    <div class="nav navbar navbar-expand-sm navbar-light">
      <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button>
      <div class="mx-auto d-sm-flex d-block flex-sm-nowrap">
        <div class="collapse navbar-collapse text-center" id="navbarNav">
          <div class="nav navbar-nav navbar-center"><a class="nav-link active" href="/">Home<span class="sr-only">(current)</span></a>
            <!--a.nav-link.disabled.d-none.d-md-block |-->
            <!--a.nav-item.nav-link(href="/dialogue") Dialogue--><a class="nav-item nav-link disabled d-none d-md-block">|</a>
            <li class="nav-item dropdown"><a class="nav-link dropdown-toggle" href="#" id="navbarDropdownMenuLink" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">About</a>
              <div class="dropdown-menu" aria-labelledby="navbarDropdownMenuLink"><a class="dropdown-item" href="/about/why">Why is this here?</a><a class="dropdown-item" href="/about/what">What is this?</a><a class="dropdown-item" href="/support">How to support this?</a></div>
            </li><a class="nav-item nav-link disabled d-none d-md-block">|</a><a class="nav-item nav-link" href="/index">Index</a><a class="nav-item nav-link disabled d-none d-md-block">|</a><a class="nav-item nav-link" href="/login">Login</a><a class="nav-item nav-link disabled d-none d-md-block">|</a><a class="nav-item nav-link" href="/support">Support</a>
          </div>
        </div>
      </div>
    </div>
    <main class="container" role="main">
      <!--p.w-75=`Datatable with property Test`-->
      <p>
        <div id="totals"></div>
        <div class="small">Data source: Johns Hopkins University Center for Systems Science and Engineering (JHU CSSE) <a href="https://github.com/CSSEGISandData/COVID-19">[link]</a></div>
      </p>
      <div id="globalPlot" align="center"></div>
      <hr>
      <div class="d-flex flex-wrap" id="countryplots"></div>
      <script>
        colors = ['black','#377eb8','#4daf4a','#984ea3','#ff7f00','darkblue','#a65628','#f781bf','#999999',
                'black','#377eb8','#4daf4a','#984ea3','#ff7f00','darkblue','#a65628','#f781bf','#999999',
                'black','#377eb8','#4daf4a','#984ea3','#ff7f00','darkblue','#a65628','#f781bf','#999999'];
        var forecastIdx;
        var forecastDays = 10
        var totalForecast = new Array(forecastDays+1).fill(0);
        
        var countryConfirmedData = {};
        var countryDeathData = {};
        var countryNormalised = [];
        
        Promise.all([
          fetch("https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_19-covid-Confirmed.csv").then(res => {return res.text()}),
          fetch("https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_19-covid-Deaths.csv").then(res => {return res.text()}),
          ])
        .then(data => {
          dataConfirmed = data[0].split('\n');
          dataDeaths = data[1].split('\n')
        
          colDateStart = 4;
        
          numCols = dataConfirmed[0].split(',').length
          dateList = dataConfirmed[0].split(',').slice(colDateStart, numCols).map(a => {return new Date(a).getTime() /1000}); 
          
          // Forecast x days
          for (var i=1; i < forecastDays; i++) {
            dateList.push(dateList[dateList.length-1] + 86400)
          }
        
          numDates = dateList.length;
          forecastIdx = numDates - forecastDays;
        
          for (var i=1; i<dataConfirmed.length; i++) {
            rowConfirmed_ = dataConfirmed[i].split(",")
            rowDeaths_ = dataDeaths[i].split(",")
            
            // Remove States/Towns
            if(rowConfirmed_.length == numCols + 1) {
              rowConfirmed_.shift();
              rowDeaths_.shift();
            }
        
            country = rowConfirmed_[1];
        
            if (country in countryConfirmedData) {
              for (var ee=colDateStart; ee<numCols; ee++) {
                countryConfirmedData[country][ee-colDateStart] = Number(countryConfirmedData[country][ee-colDateStart]) + Number(rowConfirmed_[ee])
              }
            } else {
              countryConfirmedData[country] = rowConfirmed_.slice(colDateStart, numCols)
            }
        
            if (country in countryDeathData) {
              for (var ee=colDateStart; ee<numCols; ee++) {
                countryDeathData[country][ee-colDateStart] = Number(countryDeathData[country][ee-colDateStart]) + Number(rowDeaths_[ee])
              }
            } else {
              countryDeathData[country] = rowDeaths_.slice(colDateStart, numCols)
            }
        
          }
        
          totals = [];
          for (c in countryConfirmedData) {
            d = countryConfirmedData[c];
            if (c == "Others") {
              continue;
            }
            totals.push({country: c, total:Number(d[d.length-1])})
          }
        
          //Sort totals
          totals.sort(function(a, b) {
              return ((a.total > b.total) ? -1 : ((a.total == b.total) ? 0 : 1));
          });
        
          // GLOBAL PLOT
          $("#globalPlot").append(`<h5>Top 10 countries by number of confirmed cases (excl China)</h5>`)
          plotDiv = $(`#globalPlot`)[0]
          optsGlobal = getOpts(750, 400);
          delete optsGlobal.axes[2];
          delete optsGlobal.scales['deaths'];
          labels = []
          data = [dateList.slice(0, dateList.length-forecastDays+1)]
        
          for (var i=1; i< 11; i++) {
        
            c = totals[i].country
            labels.push(c);
            data.push(countryConfirmedData[c]);
            optsGlobal = newSeries(optsGlobal, c, "confirmed", colors[i-1]);
          }
        
          //optsGlobal.legend['show'] = false;
          var uplot = new uPlot(optsGlobal, data, plotDiv);
        
          $("#globalPlot .legend").removeClass("inline")
          $("#globalPlot .legend").css("text-align", "left")
        
          //return;
        
          // COUNTRY SPECIFIC PLOTS
          for (var i=0; i<totals.length; i++) {
        
            if (isNaN(totals[i].total)) {
              continue;
            }
        
            c = totals[i].country;
            d = countryConfirmedData[c];
            dd = countryDeathData[c]
        
            // Normalise
            var ii = 0;
            var d_norm = [];
            for (var ee=0; ee<d.length-1; ee++) {
              if (d[ee] > 50) {
                d_norm.push(Number(d[ee]))
              }
            }
        
            if (d_norm.length > 0) {
              countryNormalised.push({country: c, c_norm: d_norm});
            }
        
        
            if (c != "Australia") {
              //continue;
            }
        
            optsCountry = getOpts();
            optsCountry.plugins.push(legendAsTooltipPlugin());
        
            optsCountry = newSeries(optsCountry, c + " Confirmed")
            optsCountry = newSeries(optsCountry, c + " Deaths", "deaths", "red")
            if (Number(dd[dd.length-1]) == 0) {
             // optsCountry.scales.Deaths.range = [0,1];
             // optsCountry.scales.Deaths.auto = false;
            }
        
            // Forecast
            forecastCases = new Array(numDates).fill(null); //JSON.parse(JSON.stringify(d)); //
            optsCountry = newSeries(optsCountry, `${c} forecast cases`, "confirmed", "grey", [5,2])
        
            linear_ = ((Number(d[d.length-1]) - Number(d[d.length-2])) + 
                       (Number(d[d.length-2]) - Number(d[d.length-3])))/2
        
            var multiplier = ((Number(d[d.length-1]) / Number(d[d.length-2])) + 
                             (Number(d[d.length-3]) / Number(d[d.length-4])))/2
        
            if (multiplier > 1.3 || multiplier < 0.5 || isNaN(multiplier)) {multiplier = 1.05}
        
            for (var ee=0; ee<forecastDays+1; ee++) {
              idx = numDates-forecastDays + ee;
              //var forecast_ = Number(Number(d[d.length-1])*(Math.pow(Number(multiplier),ee)))
              var forecast_ = Number(Number(d[d.length-1])+(linear_*ee));
        
              forecastCases[idx] = forecast_.toFixed(0);
              if (!isNaN(forecast_)) {
                totalForecast[ee] = Number(totalForecast[ee]) + forecast_;
              };
            }
        
            var currentNum = d[d.length-1];
            if (currentNum > 5) {
              $("#countryplots").append(`<div id="plot_${c.replace(/ /g,'')}"><h6 class="text-center mb-0">${c.replace("Mainland China", "China")} <small>(n=${currentNum})</small></h6></div>`)
              plotDiv = $(`#plot_${c.replace(/ /g,'')}`)[0]
        
              data = [dateList, d, dd, forecastCases]
              
              let country_uplot = new uPlot(optsCountry, data, plotDiv);
            }
          } 
        
        }).then(d=> {
        
          //Normalised plot
          // GLOBAL PLOT
          $("#globalPlot").append(`<p></p><hr><div id="plot_norm"><h5>Normalised infection. Days post 50 cases</h5></div>`)
        
          plotDiv = $(`#plot_norm`)[0]
          optsGlobal2 = getOpts(750, 400);
          delete optsGlobal2.axes[2];
          delete optsGlobal2.scales['deaths'];
        
        
          optsGlobal2.scales['x'].time = false;
          optsGlobal2.lock = true;
          optsGlobal2.cursor = {
              focus: {
                alpha: 0.3,
                prox: 30,
              }
            };
        
          optsGlobal2.axes[1].values = (u, vals, space) => vals.map(v => Math.pow(10, Number(v))),
        
          //optsGlobal2.plugins.push(legendAsTooltipPlugin());
          data = [Array.from(Array(50).keys())]
        
          for (var i=1; i< countryNormalised.length-1; i++) {
            c = countryNormalised[i].country  
            data.push(countryNormalised[i].c_norm.map(Math.log10));
            optsGlobal2 = newSeries(optsGlobal2, c, "confirmed", colors[i-1], [1,0], i < 11);
          }
        
        
          console.log(optsGlobal2)
        
          //optsGlobal2.legend['show'] = false;
          optsGlobal2.series[0] = {label: 'Days since 50'}
          var uplot = new uPlot(optsGlobal2, data, plotDiv);
          plotDiv = $(`#plot_norm .uplot`)[0]
          $(plotDiv).css("width", "750px")
        
          
        
        }).then(d=> {
          $("#totals").append(`Today (est): <strong>${Number(totalForecast[0]).toLocaleString()}</strong>. +7days <strong>${Number(totalForecast[8]).toLocaleString()}</strong>`)
        }) 
      </script>
    </main>
    <script src="https://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
  </body>
</html>